name: Build and Publish Docker Images

on:
  # Only run when a release is actually published (not on every push to main)
  release:
    types: [published, prereleased]

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write
  security-events: write

jobs:
  find-services:
    name: Find All Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.find.outputs.services }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: refs/tags/${{ github.event.release.tag_name }}

      - name: Find all services
        id: find
        run: |
          # Find all directories in src/services/*/*.Api with Dockerfiles
          SERVICES=()
          for api_dir in src/services/*/*.Api; do
            if [ -f "$api_dir/Dockerfile" ]; then
              # Extract service name (e.g., src/services/catalog/Catalog.Api -> catalog)
              SERVICE_NAME=$(echo "$api_dir" | sed -n 's|src/services/\([^/]*\)/.*|\1|p')
              if [ -n "$SERVICE_NAME" ]; then
                echo "Found service: $SERVICE_NAME"
                SERVICES+=("$SERVICE_NAME")
              fi
            fi
          done
          
          # Convert to JSON array
          SERVICES_JSON=$(printf '%s\n' "${SERVICES[@]}" | jq -R . | jq -s -c .)
          echo "services=$SERVICES_JSON" >> $GITHUB_OUTPUT
          echo "Services to build: $SERVICES_JSON"

  get-version:
    name: Get Release Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Get version from release
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

  find-dockerfile:
    name: Find Dockerfile for ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [find-services]
    strategy:
      matrix:
        service: ${{ fromJson(needs.find-services.outputs.services) }}
      fail-fast: false
    outputs:
      dockerfile-paths: ${{ steps.export.outputs.paths }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: refs/tags/${{ github.event.release.tag_name }}

      - name: Find Dockerfile path
        id: find
        run: |
          SERVICE_NAME="${{ matrix.service }}"
          
          # Convert service name to PascalCase for .NET project naming convention
          PASCAL_CASE=$(echo "$SERVICE_NAME" | sed 's/\b\(.\)/\u\1/g')
          
          # Common Dockerfile locations (in priority order)
          POSSIBLE_PATHS=(
            "src/services/${SERVICE_NAME}/${PASCAL_CASE}.Api/Dockerfile"
            "src/services/${SERVICE_NAME}/${SERVICE_NAME}.api/Dockerfile"
            "src/services/${SERVICE_NAME}/Dockerfile"
          )
          
          DOCKERFILE_PATH=""
          for path in "${POSSIBLE_PATHS[@]}"; do
            if [ -f "$path" ]; then
              DOCKERFILE_PATH="$path"
              echo "Found Dockerfile at: $DOCKERFILE_PATH"
              break
            fi
          done
          
          if [ -z "$DOCKERFILE_PATH" ]; then
            echo "ERROR: No Dockerfile found for service '$SERVICE_NAME'"
            exit 1
          fi
          
          echo "path=$DOCKERFILE_PATH" >> $GITHUB_OUTPUT
          echo "$SERVICE_NAME=$DOCKERFILE_PATH" >> $GITHUB_ENV

      - name: Export paths
        id: export
        run: |
          echo "paths={\"${{ matrix.service }}\":\"${{ steps.find.outputs.path }}\"}" >> $GITHUB_OUTPUT

  build-sign-sbom:
    name: Build, Sign & SBOM - ${{ matrix.service }}
    needs: [find-services, get-version, find-dockerfile]
    strategy:
      matrix:
        service: ${{ fromJson(needs.find-services.outputs.services) }}
      fail-fast: false
    uses: ./.github/workflows/reusable-build-sign-sbom.yml
    with:
      service-name: ${{ matrix.service }}
      version: ${{ needs.get-version.outputs.version }}
      dockerfile-path: src/services/${{ matrix.service }}/${{ matrix.service == 'catalog' && 'Catalog.Api' || format('{0}.Api', matrix.service) }}/Dockerfile
      docker-context: '.'
      postgres-connection: 'Host=localhost;Port=5432;Database=tempdb;Username=postgres;Password=postgres'
      rabbitmq-connection: 'amqp://guest:guest@localhost:5672/'
    secrets:
      github-token: ${{ secrets.GITHUB_TOKEN }}
