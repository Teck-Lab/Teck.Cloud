name: Build and Publish Auth Image

on:
  release:
    types: [published, prereleased]

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write
  security-events: write

jobs:
  get-version:
    name: Get Release Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Get version from release
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building auth version: $VERSION"

  check-auth:
    name: Check if auth Dockerfile exists
    runs-on: ubuntu-latest
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: refs/tags/${{ github.event.release.tag_name }}

      - name: Check for auth Dockerfile
        id: check
        run: |
          if [ -f "src/auth/Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Auth Dockerfile found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Auth Dockerfile not found - skipping"
          fi

  build-sign-sbom-auth:
    name: Build, Sign & SBOM - auth
    needs: [get-version, check-auth]
    if: needs.check-auth.outputs.exists == 'true'
    uses: ./.github/workflows/reusable-build-sign-sbom.yml
    with:
      service-name: auth
      version: ${{ needs.get-version.outputs.version }}
      dockerfile-path: src/auth/Dockerfile
      docker-context: '.'
      # Auth service doesn't need PostgreSQL/RabbitMQ (Keycloak-based)
      postgres-connection: ''
      rabbitmq-connection: ''
    secrets:
      github-token: ${{ secrets.GITHUB_TOKEN }}
