name: Reusable Build, Sign, and SBOM Generation (SLSA L3)

on:
  workflow_call:
    inputs:
      service-name:
        description: 'Service name (e.g., catalog)'
        required: true
        type: string
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        type: string
      dockerfile-path:
        description: 'Path to Dockerfile'
        required: true
        type: string
      docker-context:
        description: 'Docker build context path'
        required: false
        type: string
        default: '.'
      postgres-connection:
        description: 'PostgreSQL connection string for Wolverine codegen'
        required: false
        type: string
        default: 'Host=localhost;Port=5432;Database=tempdb;Username=postgres;Password=postgres'
      rabbitmq-connection:
        description: 'RabbitMQ connection string for Wolverine codegen'
        required: false
        type: string
        default: 'amqp://guest:guest@localhost:5672/'
    secrets:
      github-token:
        description: 'GitHub token for authentication and release uploads'
        required: true

permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write
  security-events: write

jobs:
  build-and-push:
    name: Build ${{ inputs.service-name }} (${{ matrix.builder.platform }})
    runs-on: ${{ matrix.builder.runner-image }}
    
    # Service containers needed for Wolverine codegen during build
    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: tempdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      rabbitmq:
        image: rabbitmq:3-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5672:5672
          - 15672:15672
    
    strategy:
      matrix:
        builder:
          - runner-image: ubuntu-24.04
            platform: linux/amd64
          - runner-image: ubuntu-24.04-arm
            platform: linux/arm64
      fail-fast: false
    
    outputs:
      digest-amd64: ${{ steps.export-digest.outputs.digest-amd64 }}
      digest-arm64: ${{ steps.export-digest.outputs.digest-arm64 }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: refs/tags/v${{ inputs.version }}

      - name: Prepare environment variables
        run: |
          echo "PLATFORM_PAIR=$(echo '${{ matrix.builder.platform }}' | sed 's/\//-/')" >> $GITHUB_ENV
          # Lowercase repository owner for Docker image name (Docker requires lowercase)
          REPO_OWNER_LOWER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=ghcr.io/${REPO_OWNER_LOWER}/teck-cloud/${{ inputs.service-name }}" >> $GITHUB_ENV

      - name: Set up QEMU
        uses: docker/setup-qemu-action@49b3bc8e6bdd4a60e6116a5414239cba5943d3cf # v3.2.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3.7.1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.github-token }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@8e5442c4ef9f78752691e2d8f8d19755c6f78e81 # v5.5.1
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ inputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ inputs.version }}
            type=semver,pattern={{major}},value=${{ inputs.version }},enable=${{ !startsWith(inputs.version, '0.') }}
            type=raw,value=latest,enable=${{ !contains(inputs.version, '-') }}
          labels: |
            org.opencontainers.image.title=${{ inputs.service-name }}
            org.opencontainers.image.description=Teck Cloud microservice - ${{ inputs.service-name }}
            org.opencontainers.image.vendor=Teck
            com.teck.service.name=${{ inputs.service-name }}
            com.teck.build.workflow=${{ github.workflow }}
            com.teck.build.run-id=${{ github.run_id }}
            com.teck.build.run-number=${{ github.run_number }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@48aba3b46d1b1fec4febb7c5d0c644b249a11355 # v6.10.0
        with:
          context: ${{ inputs.docker-context }}
          file: ${{ inputs.dockerfile-path }}
          platforms: ${{ matrix.builder.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=image,name=${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=${{ inputs.service-name }}-${{ matrix.builder.platform }}
          cache-to: type=gha,mode=max,scope=${{ inputs.service-name }}-${{ matrix.builder.platform }}
          network: host
          build-args: |
            VERSION=${{ inputs.version }}
            POSTGRES_CONNECTION=${{ inputs.postgres-connection }}
            RABBITMQ_CONNECTION=${{ inputs.rabbitmq-connection }}

      - name: Export digest
        id: export-digest
        run: |
          mkdir -p /tmp/digests/${{ inputs.service-name }}
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${{ inputs.service-name }}/${digest#sha256:}"
          echo "digest-${{ env.PLATFORM_PAIR }}=$digest" >> $GITHUB_OUTPUT

      - name: Upload digest
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: digests-${{ inputs.service-name }}-${{ env.PLATFORM_PAIR }}
          path: /tmp/digests/${{ inputs.service-name }}/*
          if-no-files-found: error
          retention-days: 1

  merge-manifests:
    name: Merge ${{ inputs.service-name }} manifests
    runs-on: ubuntu-latest
    needs: [build-and-push]
    outputs:
      digest: ${{ steps.merge.outputs.digest }}
      image-ref: ${{ steps.image-ref.outputs.ref }}
    
    steps:
      - name: Download digests
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: /tmp/digests
          pattern: digests-${{ inputs.service-name }}-*
          merge-multiple: true

      - name: Prepare environment variables
        run: |
          # Lowercase repository owner for Docker image name (Docker requires lowercase)
          REPO_OWNER_LOWER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME=ghcr.io/${REPO_OWNER_LOWER}/teck-cloud/${{ inputs.service-name }}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c47758b77c9736f4b2ef4073d4d51994fabfe349 # v3.7.1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.github-token }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@8e5442c4ef9f78752691e2d8f8d19755c6f78e81 # v5.5.1
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}},value=${{ inputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ inputs.version }}
            type=semver,pattern={{major}},value=${{ inputs.version }},enable=${{ !startsWith(inputs.version, '0.') }}
            type=raw,value=latest,enable=${{ !contains(inputs.version, '-') }}

      - name: Create manifest list and push
        id: merge
        working-directory: /tmp/digests
        env:
          DOCKER_METADATA_OUTPUT_JSON: ${{ steps.meta.outputs.json }}
        run: |
          # Create the manifest and capture the digest
          # Deduplicate tags to avoid "412 Precondition Failed" errors
          TAGS=$(jq -cr '.tags | unique | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON")
          docker buildx imagetools create $TAGS \
            $(printf '${{ env.IMAGE_NAME }}@sha256:%s ' *)
          
          # Inspect the image to get the digest
          DIGEST=$(docker buildx imagetools inspect ${{ env.IMAGE_NAME }}:${{ inputs.version }} --raw | sha256sum | awk '{print "sha256:"$1}')
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "Image digest: $DIGEST"

      - name: Set image reference
        id: image-ref
        run: |
          echo "ref=${{ env.IMAGE_NAME }}@${{ steps.merge.outputs.digest }}" >> $GITHUB_OUTPUT

      - name: Inspect image
        run: |
          docker buildx imagetools inspect ${{ env.IMAGE_NAME }}:${{ inputs.version }}

  scan-vulnerabilities:
    name: Scan ${{ inputs.service-name }} vulnerabilities
    runs-on: ubuntu-latest
    needs: [merge-manifests]
    
    steps:
      - name: Set image reference
        id: set-image
        run: |
          REPO_OWNER_LOWER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          IMAGE_REF="ghcr.io/${REPO_OWNER_LOWER}/teck-cloud/${{ inputs.service-name }}@${{ needs.merge-manifests.outputs.digest }}"
          echo "ref=$IMAGE_REF" >> $GITHUB_OUTPUT
          echo "Image reference: $IMAGE_REF"
          
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.github-token }}

      - name: Run Trivy vulnerability scanner (SARIF)
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284 # 0.31.0
        continue-on-error: true
        env:
          TRIVY_USERNAME: ${{ github.actor }}
          TRIVY_PASSWORD: ${{ secrets.github-token }}
        with:
          image-ref: ${{ steps.set-image.outputs.ref }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: 1
          ignore-unfixed: true

      - name: Upload Trivy results to Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@b5ebac6f4c00c8ccddb7cdcd45fdb248329f808a # v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-image-${{ inputs.service-name }}'

      - name: Run Trivy vulnerability scanner (JSON)
        if: always()
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284 # 0.31.0
        env:
          TRIVY_USERNAME: ${{ github.actor }}
          TRIVY_PASSWORD: ${{ secrets.github-token }}
        with:
          image-ref: ${{ steps.set-image.outputs.ref }}
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          ignore-unfixed: true

      - name: Upload Trivy JSON report
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: trivy-scan-${{ inputs.service-name }}
          path: trivy-results.json
          retention-days: 90

  generate-sboms:
    name: Generate SBOMs for ${{ inputs.service-name }}
    runs-on: ubuntu-latest
    needs: [merge-manifests]
    outputs:
      spdx-sbom: sbom-${{ inputs.service-name }}.spdx.json
      cyclonedx-sbom: sbom-${{ inputs.service-name }}.cyclonedx.json
    
    steps:
      - name: Set image reference
        id: set-image
        run: |
          REPO_OWNER_LOWER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          IMAGE_REF="ghcr.io/${REPO_OWNER_LOWER}/teck-cloud/${{ inputs.service-name }}@${{ needs.merge-manifests.outputs.digest }}"
          echo "ref=$IMAGE_REF" >> $GITHUB_OUTPUT
          echo "Image reference: $IMAGE_REF"
          
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.github-token }}

      - name: Generate SPDX SBOM
        uses: anchore/sbom-action@28d71544de8eaf1b958d335707167c5f783590ad # v0.22.2
        with:
          image: ${{ steps.set-image.outputs.ref }}
          format: spdx-json
          output-file: sbom-${{ inputs.service-name }}.spdx.json
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.github-token }}

      - name: Generate CycloneDX SBOM
        uses: anchore/sbom-action@28d71544de8eaf1b958d335707167c5f783590ad # v0.22.2
        with:
          image: ${{ steps.set-image.outputs.ref }}
          format: cyclonedx-json
          output-file: sbom-${{ inputs.service-name }}.cyclonedx.json
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.github-token }}

      - name: Upload SPDX SBOM artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: sbom-spdx-${{ inputs.service-name }}
          path: sbom-${{ inputs.service-name }}.spdx.json
          retention-days: 90

      - name: Upload CycloneDX SBOM artifact
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: sbom-cyclonedx-${{ inputs.service-name }}
          path: sbom-${{ inputs.service-name }}.cyclonedx.json
          retention-days: 90

  sign-sboms:
    name: Sign SBOMs for ${{ inputs.service-name }}
    runs-on: ubuntu-latest
    needs: [merge-manifests, generate-sboms]
    
    steps:
      - name: Set image name
        id: set-image
        run: |
          REPO_OWNER_LOWER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          echo "name=ghcr.io/${REPO_OWNER_LOWER}/teck-cloud/${{ inputs.service-name }}" >> $GITHUB_OUTPUT
          
      - name: Download SPDX SBOM
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: sbom-spdx-${{ inputs.service-name }}

      - name: Download CycloneDX SBOM
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: sbom-cyclonedx-${{ inputs.service-name }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign SPDX SBOM with Cosign
        run: |
          cosign sign-blob --yes \
            --bundle sbom-${{ inputs.service-name }}.spdx.json.bundle \
            sbom-${{ inputs.service-name }}.spdx.json
          
          # Extract signature and certificate for separate storage (Cosign bundle v0.3 format)
          cat sbom-${{ inputs.service-name }}.spdx.json.bundle | jq -r '.messageSignature.signature' | base64 -d > sbom-${{ inputs.service-name }}.spdx.json.sig
          cat sbom-${{ inputs.service-name }}.spdx.json.bundle | jq -r '.verificationMaterial.certificate.rawBytes' | base64 -d > sbom-${{ inputs.service-name }}.spdx.json.cert

      - name: Sign CycloneDX SBOM with Cosign
        run: |
          cosign sign-blob --yes \
            --bundle sbom-${{ inputs.service-name }}.cyclonedx.json.bundle \
            sbom-${{ inputs.service-name }}.cyclonedx.json
          
          # Extract signature and certificate (Cosign bundle v0.3 format)
          cat sbom-${{ inputs.service-name }}.cyclonedx.json.bundle | jq -r '.messageSignature.signature' | base64 -d > sbom-${{ inputs.service-name }}.cyclonedx.json.sig
          cat sbom-${{ inputs.service-name }}.cyclonedx.json.bundle | jq -r '.verificationMaterial.certificate.rawBytes' | base64 -d > sbom-${{ inputs.service-name }}.cyclonedx.json.cert

      - name: Verify SPDX SBOM signature
        run: |
          cosign verify-blob \
            --bundle sbom-${{ inputs.service-name }}.spdx.json.bundle \
            --certificate-identity-regexp="^https://github.com/${{ github.repository }}/.*" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            sbom-${{ inputs.service-name }}.spdx.json

      - name: Verify CycloneDX SBOM signature
        run: |
          cosign verify-blob \
            --bundle sbom-${{ inputs.service-name }}.cyclonedx.json.bundle \
            --certificate-identity-regexp="^https://github.com/${{ github.repository }}/.*" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            sbom-${{ inputs.service-name }}.cyclonedx.json

      - name: Attest SPDX SBOM
        uses: actions/attest-sbom@5026d3663739160db546203eeaffa6aa1c51a4d6 # v1
        with:
          subject-name: ${{ steps.set-image.outputs.name }}
          subject-digest: ${{ needs.merge-manifests.outputs.digest }}
          sbom-path: sbom-${{ inputs.service-name }}.spdx.json

      - name: Upload signed SPDX SBOM artifacts
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: sbom-spdx-signed-${{ inputs.service-name }}
          path: |
            sbom-${{ inputs.service-name }}.spdx.json
            sbom-${{ inputs.service-name }}.spdx.json.sig
            sbom-${{ inputs.service-name }}.spdx.json.cert
            sbom-${{ inputs.service-name }}.spdx.json.bundle
          retention-days: 90

      - name: Upload signed CycloneDX SBOM artifacts
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: sbom-cyclonedx-signed-${{ inputs.service-name }}
          path: |
            sbom-${{ inputs.service-name }}.cyclonedx.json
            sbom-${{ inputs.service-name }}.cyclonedx.json.sig
            sbom-${{ inputs.service-name }}.cyclonedx.json.cert
            sbom-${{ inputs.service-name }}.cyclonedx.json.bundle
          retention-days: 90

  generate-vex:
    name: Generate VEX for ${{ inputs.service-name }}
    runs-on: ubuntu-latest
    needs: [merge-manifests, generate-sboms, scan-vulnerabilities]
    
    steps:
      - name: Set image reference
        id: set-image
        run: |
          IMAGE_REF="ghcr.io/${{ github.repository_owner }}/teck-cloud/${{ inputs.service-name }}@${{ needs.merge-manifests.outputs.digest }}"
          echo "ref=$IMAGE_REF" >> $GITHUB_OUTPUT
          
      - name: Download SPDX SBOM
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: sbom-spdx-${{ inputs.service-name }}

      - name: Download Trivy scan results
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: trivy-scan-${{ inputs.service-name }}

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Run Grype scan with reachability analysis
        run: |
          grype sbom:sbom-${{ inputs.service-name }}.spdx.json \
            -o json \
            --file grype-results.json

      - name: Generate OpenVEX document
        run: |
          # Create VEX document structure
          cat > vex-${{ inputs.service-name }}.openvex.json <<'EOF'
          {
            "@context": "https://openvex.dev/ns/v0.2.0",
            "@id": "https://github.com/${{ github.repository }}/releases/download/v${{ inputs.version }}/vex-${{ inputs.service-name }}.openvex.json",
            "author": "Teck Build System",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "version": "1",
            "tooling": "Grype + Trivy",
            "statements": []
          }
          EOF
          
          # Parse Grype results and add VEX statements
          # For each vulnerability, determine exploitability status
          if [ -f grype-results.json ]; then
            python3 -c '
          import json
          import sys
          
          with open("grype-results.json") as f:
              grype = json.load(f)
          
          with open("vex-${{ inputs.service-name }}.openvex.json") as f:
              vex = json.load(f)
          
          statements = []
          for match in grype.get("matches", []):
              vuln = match.get("vulnerability", {})
              vuln_id = vuln.get("id", "")
              
              # Determine status based on fix availability and severity
              severity = vuln.get("severity", "Unknown")
              fix_versions = match.get("vulnerability", {}).get("fix", {}).get("versions", [])
              
              status = "affected"
              justification = None
              
              # If no fix available, mark as under_investigation
              if not fix_versions:
                  status = "under_investigation"
              
              # Add VEX statement
              statement = {
                  "vulnerability": {"name": vuln_id},
                  "timestamp": vex["timestamp"],
                  "products": [{
                      "component": {
                          "id": "${{ steps.set-image.outputs.ref }}"
                      }
                  }],
                  "status": status
              }
              
              if justification:
                  statement["justification"] = justification
              
              if fix_versions:
                  statement["action_statement"] = f"Update to version {fix_versions[0]} or later"
              
              statements.append(statement)
          
          vex["statements"] = statements
          
          with open("vex-${{ inputs.service-name }}.openvex.json", "w") as f:
              json.dump(vex, f, indent=2)
          '
          fi
          
          echo "VEX document generated with $(cat vex-${{ inputs.service-name }}.openvex.json | jq '.statements | length') statements"

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign VEX document
        run: |
          cosign sign-blob --yes \
            --bundle vex-${{ inputs.service-name }}.openvex.json.bundle \
            vex-${{ inputs.service-name }}.openvex.json
          
          # Extract signature and certificate (Cosign bundle v0.3 format)
          cat vex-${{ inputs.service-name }}.openvex.json.bundle | jq -r '.messageSignature.signature' | base64 -d > vex-${{ inputs.service-name }}.openvex.json.sig
          cat vex-${{ inputs.service-name }}.openvex.json.bundle | jq -r '.verificationMaterial.certificate.rawBytes' | base64 -d > vex-${{ inputs.service-name }}.openvex.json.cert

      - name: Verify VEX signature
        run: |
          cosign verify-blob \
            --bundle vex-${{ inputs.service-name }}.openvex.json.bundle \
            --certificate-identity-regexp="^https://github.com/${{ github.repository }}/.*" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            vex-${{ inputs.service-name }}.openvex.json

      - name: Upload VEX artifacts
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: vex-${{ inputs.service-name }}
          path: |
            vex-${{ inputs.service-name }}.openvex.json
            vex-${{ inputs.service-name }}.openvex.json.sig
            vex-${{ inputs.service-name }}.openvex.json.cert
            vex-${{ inputs.service-name }}.openvex.json.bundle
            grype-results.json
          retention-days: 90

  sign-image:
    name: Sign ${{ inputs.service-name }} image
    runs-on: ubuntu-latest
    needs: [merge-manifests, scan-vulnerabilities]
    
    steps:
      - name: Set image reference
        id: set-image
        run: |
          REPO_OWNER_LOWER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME="ghcr.io/${REPO_OWNER_LOWER}/teck-cloud/${{ inputs.service-name }}"
          IMAGE_REF="$IMAGE_NAME@${{ needs.merge-manifests.outputs.digest }}"
          echo "ref=$IMAGE_REF" >> $GITHUB_OUTPUT
          echo "name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          
      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.github-token }}

      - name: Sign container image
        run: |
          cosign sign --yes \
            ${{ steps.set-image.outputs.ref }}

      - name: Verify image signature
        run: |
          cosign verify \
            --certificate-identity-regexp="^https://github.com/${{ github.repository }}/.*" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            ${{ steps.set-image.outputs.ref }}

      - name: Generate build provenance attestation (SLSA L3)
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-name: ${{ steps.set-image.outputs.name }}
          subject-digest: ${{ needs.merge-manifests.outputs.digest }}
          push-to-registry: true

  upload-to-release:
    name: Upload artifacts to GitHub Release
    runs-on: ubuntu-latest
    needs: [merge-manifests, sign-sboms, generate-vex, sign-image, scan-vulnerabilities]
    
    steps:
      - name: Set image reference
        id: set-image
        run: |
          IMAGE_REF="ghcr.io/${{ github.repository_owner }}/teck-cloud/${{ inputs.service-name }}@${{ needs.merge-manifests.outputs.digest }}"
          echo "ref=$IMAGE_REF" >> $GITHUB_OUTPUT
          
      - name: Download signed SPDX SBOM
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: sbom-spdx-signed-${{ inputs.service-name }}
          path: artifacts/sbom-spdx-signed-${{ inputs.service-name }}

      - name: Download signed CycloneDX SBOM
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: sbom-cyclonedx-signed-${{ inputs.service-name }}
          path: artifacts/sbom-cyclonedx-signed-${{ inputs.service-name }}

      - name: Download VEX documents
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: vex-${{ inputs.service-name }}
          path: artifacts/vex-${{ inputs.service-name }}

      - name: Download Trivy scan results
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: trivy-scan-${{ inputs.service-name }}
          path: artifacts/trivy-scan-${{ inputs.service-name }}

      - name: Organize release artifacts
        run: |
          mkdir -p release-assets
          
          # SPDX SBOM files
          cp artifacts/sbom-spdx-signed-${{ inputs.service-name }}/sbom-${{ inputs.service-name }}.spdx.json release-assets/
          cp artifacts/sbom-spdx-signed-${{ inputs.service-name }}/sbom-${{ inputs.service-name }}.spdx.json.sig release-assets/
          cp artifacts/sbom-spdx-signed-${{ inputs.service-name }}/sbom-${{ inputs.service-name }}.spdx.json.cert release-assets/
          
          # CycloneDX SBOM files
          cp artifacts/sbom-cyclonedx-signed-${{ inputs.service-name }}/sbom-${{ inputs.service-name }}.cyclonedx.json release-assets/
          cp artifacts/sbom-cyclonedx-signed-${{ inputs.service-name }}/sbom-${{ inputs.service-name }}.cyclonedx.json.sig release-assets/
          cp artifacts/sbom-cyclonedx-signed-${{ inputs.service-name }}/sbom-${{ inputs.service-name }}.cyclonedx.json.cert release-assets/
          
          # VEX files
          cp artifacts/vex-${{ inputs.service-name }}/vex-${{ inputs.service-name }}.openvex.json release-assets/
          cp artifacts/vex-${{ inputs.service-name }}/vex-${{ inputs.service-name }}.openvex.json.sig release-assets/
          cp artifacts/vex-${{ inputs.service-name }}/vex-${{ inputs.service-name }}.openvex.json.cert release-assets/
          
          # Trivy scan results
          cp artifacts/trivy-scan-${{ inputs.service-name }}/trivy-results.json release-assets/trivy-scan-${{ inputs.service-name }}.json
          
          ls -lah release-assets/

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.github-token }}
        run: |
          # Upload all files to the release
          cd release-assets
          for file in *; do
            gh release upload v${{ inputs.version }} "$file" \
              --repo ${{ github.repository }} \
              --clobber
          done

      - name: Create release summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          ## ðŸŽ‰ Build Complete: ${{ inputs.service-name }} v${{ inputs.version }}
          
          ### ðŸ“¦ Image Details
          - **Image**: `${{ steps.set-image.outputs.ref }}`
          - **Version**: `${{ inputs.version }}`
          - **Platforms**: linux/amd64, linux/arm64
          - **Signed**: âœ… Yes (Cosign keyless with Sigstore)
          
          ### ðŸ“‹ SBOMs Generated
          - âœ… SPDX JSON (signed)
          - âœ… CycloneDX JSON (signed)
          
          ### ðŸ›¡ï¸ Security Artifacts
          - âœ… VEX document (signed)
          - âœ… Trivy vulnerability scan
          - âœ… SLSA Build L3 provenance attestation
          
          ### ðŸ” Verification Commands
          
          **Verify image signature:**
          ```bash
          cosign verify \
            --certificate-identity-regexp="^https://github.com/${{ github.repository }}/.*" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            ${{ steps.set-image.outputs.ref }}
          ```
          
          **Verify SBOM attestation:**
          ```bash
          gh attestation verify oci://${{ steps.set-image.outputs.ref }} --owner ${{ github.repository_owner }}
          ```
          
          **Download SBOMs from release:**
          ```bash
          gh release download v${{ inputs.version }} --pattern "sbom-${{ inputs.service-name }}.*"
          ```
          EOF
